name: Create Jira issue

on:
  issues:
    types:
      - opened
      - closed

permissions:
  contents: read
  issues: write

jobs:
  # ------------------------------------------------------------------
  # 1. ì´ìŠˆ ìƒì„± ì‹œ ì‹¤í–‰ (Opened)
  # ------------------------------------------------------------------
  create-issue:
    if: github.event.action == 'opened'
    name: Create Jira issue
    runs-on: ubuntu-latest

    steps:
      - name: Login
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      - name: Checkout main code
        uses: actions/checkout@v4
        with:
          ref: main

      # --------------------------------------------------------------
      # Epic Key ì¶”ì¶œ (ì´ìŠˆ bodyì—ì„œ DEV-ìˆ«ì í˜•íƒœ ì°¾ê¸°)
      # --------------------------------------------------------------
      - name: Extract Epic Key
        id: epic
        run: |
          EPIC_KEY=$(echo "${{ github.event.issue.body }}" | grep -oE 'FLOW-[0-9]+' | head -n 1)
          echo "EPIC_KEY=$EPIC_KEY" >> $GITHUB_OUTPUT
          echo "Detected Epic Key: $EPIC_KEY"

      - name: Convert markdown to Jira Syntax
        uses: peter-evans/jira2md@v1
        id: md2jira
        with:
          input-text: |
            ### Github Issue Link
            - ${{ github.event.issue.html_url }}

            ### Epic
            - ${{ steps.epic.outputs.EPIC_KEY }}

            ---
            ${{ github.event.issue.body }}
          mode: md2jira

      # --------------------------------------------------------------
      # Jira ì´ìŠˆ ìƒì„± + Epic ìë™ ê·€ì†
      # --------------------------------------------------------------
      - name: Create Jira Issue
        id: create
        uses: atlassian/gajira-create@v3
        with:
          project: FLOW
          issuetype: Task
          summary: '${{ github.event.issue.title }}'
          description: '${{ steps.md2jira.outputs.output-text }}'
          fields: |
            {
              "parent": {
                "key": "${{ steps.epic.outputs.EPIC_KEY }}"
              }
            }

      - name: Log created issue
        run: echo "Jira Issue ${{ steps.create.outputs.issue }} was created"

      - name: Update issue title
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-issue'
          token: ${{ secrets.GITHUB_TOKEN }}
          title: '[${{ steps.create.outputs.issue }}] ${{ github.event.issue.title }}'

      - name: Add comment with Jira issue link
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ğŸ« **Jira Issue Created**
            - Epic: ${{ steps.epic.outputs.EPIC_KEY }}
            - Issue: [${{ steps.create.outputs.issue }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.create.outputs.issue }})

  # ------------------------------------------------------------------
  # 2. ì´ìŠˆ ë‹«í˜ ì‹œ ì‹¤í–‰ (Closed)
  # ------------------------------------------------------------------
  close-issue:
    if: github.event.action == 'closed'
    name: Close Jira issue
    runs-on: ubuntu-latest

    steps:
      - name: Login
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      - name: Find Issue Key
        id: find
        uses: atlassian/gajira-find-issue-key@v3
        with:
          string: ${{ github.event.issue.title }}

      - name: Transition Issue to Done
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.find.outputs.issue }}
          transition: "ì™„ë£Œ"
